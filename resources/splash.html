<!DOCTYPE html>
<html lang="nl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gavotte Network Setup</title>
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}
		
		.container {
			background: white;
			border-radius: 12px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			width: 100%;
			max-width: 400px;
		}
		
		h1 {
			text-align: center;
			color: #333;
			margin-bottom: 30px;
			font-size: 24px;
			font-weight: 600;
		}
		
		.form-group {
			margin-bottom: 20px;
		}
		
		label {
			display: block;
			margin-bottom: 8px;
			color: #555;
			font-weight: 500;
			font-size: 16px;
		}
		
		select, input[type="text"], input[type="password"] {
			width: 100%;
			padding: 15px;
			border: 2px solid #e1e5e9;
			border-radius: 8px;
			font-size: 16px;
			background: white;
			transition: border-color 0.3s ease;
		}
		
		select:focus, input[type="text"]:focus, input[type="password"]:focus {
			outline: none;
			border-color: #667eea;
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
		}
		
		select {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
			background-position: right 12px center;
			background-repeat: no-repeat;
			background-size: 16px;
			padding-right: 40px;
		}
		
		.submit-btn {
			width: 100%;
			padding: 16px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 8px;
			font-size: 18px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
			margin-top: 10px;
		}
		
		.submit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
		}
		
		.submit-btn:active {
			transform: translateY(0);
		}
		
		.status {
			text-align: center;
			margin-bottom: 15px;
			padding: 10px;
			border-radius: 6px;
			font-size: 14px;
		}
		
		.status.loading {
			background: #e3f2fd;
			color: #1976d2;
		}
		
		.status.error {
			background: #ffebee;
			color: #c62828;
		}
		
		/* iOS Safari specific fixes */
		@supports (-webkit-appearance: none) {
			select, input[type="text"], input[type="password"] {
				-webkit-appearance: none;
				-moz-appearance: none;
				appearance: none;
				border-radius: 8px;
			}
		}
		
		/* Android specific fixes */
		@media screen and (-webkit-min-device-pixel-ratio: 0) {
			select {
				border-radius: 8px;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Gavotte Network Setup</h1>
		
		<div id="status" class="status loading" style="display: none;">
			Scanning for networks...
		</div>
		
		<form id="wifiForm" action="/save" method="post">
			<div class="form-group">
				<label for="ssid">Choose Network:</label>
				<select id="ssid" name="ssid" required>
					<option value="">Scanning...</option>
				</select>
			</div>
			
			<div class="form-group">
				<label for="password">Password:</label>
				<input type="text" id="password" name="password" placeholder="Enter WiFi password">
				<div style="margin-top: 8px;">
					<input type="checkbox" id="hidePassword" style="margin-right: 8px;">
					<label for="hidePassword" style="font-size: 14px; color: #666; margin-bottom: 0;">Hide password</label>
				</div>
			</div>
			
			<button type="submit" class="submit-btn">Connect</button>
		</form>
	</div>

	<script>
		function showStatus(message, type = 'loading') {
			const status = document.getElementById('status');
			status.textContent = message;
			status.className = `status ${type}`;
			status.style.display = 'block';
		}
		
		function hideStatus() {
			document.getElementById('status').style.display = 'none';
		}
		
		async function loadNetworks() {
			const select = document.getElementById('ssid');
			showStatus('Scanning for networks...');
			
			try {
				const response = await fetch('/wifi-networks.json');
				if (response.ok) {
					const networks = await response.json();
					populateNetworks(networks);
				} else {
					// Fallback networks
					const fallback = ['HomeNetwork', 'OfficeWiFi', 'GuestAccess'];
					populateNetworks(fallback);
				}
			} catch (error) {
				console.log('Network scan failed:', error);
				const fallback = ['HomeNetwork', 'OfficeWiFi', 'GuestAccess'];
				populateNetworks(fallback);
			}
		}
		
		function populateNetworks(networks) {
			const select = document.getElementById('ssid');
			select.innerHTML = '';
			
			if (networks.length === 0) {
				select.innerHTML = '<option value="">No networks found</option>';
				showStatus('No networks found', 'error');
				return;
			}
			
			// Add placeholder
			const placeholder = document.createElement('option');
			placeholder.value = '';
			placeholder.textContent = 'Select a network...';
			placeholder.disabled = true;
			placeholder.selected = true;
			select.appendChild(placeholder);
			
			// Add networks (remove duplicates and sort)
			const unique = [...new Set(networks)].sort();
			unique.forEach(network => {
				if (network && network.trim()) {
					const option = document.createElement('option');
					option.value = network;
					option.textContent = network;
					select.appendChild(option);
				}
			});
			
			hideStatus();
		}
		
		// Exit portal function
		function exitPortal() {
			// Try multiple methods to close/exit
			if (window.close) {
				window.close();
			}
			// If that doesn't work, just show portal closed message
			setTimeout(() => {
				document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial;"><h1>Portal Closed</h1></div>';
			}, 100);
		}
		
		// Form submission
		document.getElementById('wifiForm').addEventListener('submit', function(e) {
			e.preventDefault(); // Prevent default form submission
			
			const ssid = document.getElementById('ssid').value;
			const password = document.getElementById('password').value;
			
			if (!ssid) {
				showStatus('Please select a network', 'error');
				return;
			}
			
			// Show loading message and disable form
			showStatus('Connecting to ' + ssid + '...', 'loading');
			const submitBtn = document.querySelector('.submit-btn');
			submitBtn.disabled = true;
			submitBtn.textContent = 'Connecting...';
			
			// Submit via fetch to handle response properly
			const formData = new FormData();
			formData.append('ssid', ssid);
			formData.append('password', password);
			
			fetch('/save', {
				method: 'POST',
				body: formData
			}).then(response => {
				// Show success page with countdown timer
				let countdown = 5;
				console.log('SSID value:', ssid); // Debug log
				document.querySelector('.container').innerHTML = `
					<div style="text-align: center; padding: 20px;">
						<h1 style="color: #4CAF50; margin-bottom: 20px;">âœ“ Configuration Saved!</h1>
						<p style="margin-bottom: 15px; color: #666;">WiFi settings have been saved successfully.</p>
						<p style="margin-bottom: 20px; color: #666;">The device will now connect to <strong>` + ssid + `</strong></p>
						<div style="background: #e8f5e8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
							<p style="color: #2e7d32; margin: 0;">ðŸ”„ Connecting to network...</p>
						</div>
						<p style="font-size: 18px; color: #333; margin-bottom: 20px;">
							Portal closing in <span id="countdown" style="font-weight: bold; color: #4CAF50;">` + countdown + `</span> seconds
						</p>
						<button onclick="exitPortal()" style="
							background: #4CAF50; 
							color: white; 
							border: none; 
							padding: 12px 24px; 
							border-radius: 5px; 
							font-size: 16px; 
							cursor: pointer;
							margin-top: 10px;
						">Exit Now</button>
					</div>
				`;
				
				// Start countdown timer
				const timer = setInterval(() => {
					countdown--;
					const countdownElement = document.getElementById('countdown');
					if (countdownElement) {
						countdownElement.textContent = countdown;
					}
					if (countdown <= 0) {
						clearInterval(timer);
						exitPortal();
					}
				}, 1000);
			}).catch(error => {
				// Even on error (503), show success with countdown since config was likely saved
				let countdown = 5;
				console.log('SSID value in catch:', ssid); // Debug log
				document.querySelector('.container').innerHTML = `
					<div style="text-align: center; padding: 20px;">
						<h1 style="color: #4CAF50; margin-bottom: 20px;">âœ“ Configuration Saved!</h1>
						<p style="margin-bottom: 15px; color: #666;">WiFi settings have been saved successfully.</p>
						<p style="margin-bottom: 20px; color: #666;">The device will now connect to <strong>` + ssid + `</strong></p>
						<div style="background: #e8f5e8; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
							<p style="color: #2e7d32; margin: 0;">ðŸ”„ Connecting to network...</p>
						</div>
						<p style="font-size: 18px; color: #333; margin-bottom: 20px;">
							Portal closing in <span id="countdown" style="font-weight: bold; color: #4CAF50;">` + countdown + `</span> seconds
						</p>
						<button onclick="exitPortal()" style="
							background: #4CAF50; 
							color: white; 
							border: none; 
							padding: 12px 24px; 
							border-radius: 5px; 
							font-size: 16px; 
							cursor: pointer;
							margin-top: 10px;
						">Exit Now</button>
					</div>
				`;
				
				// Start countdown timer
				const timer = setInterval(() => {
					countdown--;
					const countdownElement = document.getElementById('countdown');
					if (countdownElement) {
						countdownElement.textContent = countdown;
					}
					if (countdown <= 0) {
						clearInterval(timer);
						exitPortal();
					}
				}, 1000);
			});
		});
		
		// Password toggle functionality
		document.getElementById('hidePassword').addEventListener('change', function() {
			const passwordField = document.getElementById('password');
			if (this.checked) {
				passwordField.type = 'password';
			} else {
				passwordField.type = 'text';
			}
		});
		
		// Load networks when page loads
		window.addEventListener('load', loadNetworks);
	</script>
</body>
</html>
